From 94a2ba5780b3ea7d8ed8da66e93cba7cfdc16201 Mon Sep 17 00:00:00 2001
From: loongson <loongson@loongson-pc>
Date: Wed, 22 Jan 2025 14:31:41 +0800
Subject: [PATCH] add loongarch support

---
 etc/config.sh/settings                   |  9 ++++++++
 wmake/rules/linuxClang/c                 |  2 +-
 wmake/rules/linuxClang/c++               |  2 +-
 wmake/rules/linuxGcc/c                   |  2 +-
 wmake/rules/linuxGcc/c++                 |  2 +-
 wmake/rules/linuxLOONGARCH64Gcc/X        |  3 +++
 wmake/rules/linuxLOONGARCH64Gcc/c        | 18 ++++++++++++++++
 wmake/rules/linuxLOONGARCH64Gcc/c++      | 26 ++++++++++++++++++++++++
 wmake/rules/linuxLOONGARCH64Gcc/c++Debug |  2 ++
 wmake/rules/linuxLOONGARCH64Gcc/c++Opt   |  4 ++++
 wmake/rules/linuxLOONGARCH64Gcc/c++Prof  |  2 ++
 wmake/rules/linuxLOONGARCH64Gcc/cDebug   |  2 ++
 wmake/rules/linuxLOONGARCH64Gcc/cOpt     |  2 ++
 wmake/rules/linuxLOONGARCH64Gcc/cProf    |  2 ++
 wmake/rules/linuxLOONGARCH64Gcc/general  |  9 ++++++++
 15 files changed, 83 insertions(+), 4 deletions(-)
 create mode 100644 wmake/rules/linuxLOONGARCH64Gcc/X
 create mode 100644 wmake/rules/linuxLOONGARCH64Gcc/c
 create mode 100644 wmake/rules/linuxLOONGARCH64Gcc/c++
 create mode 100644 wmake/rules/linuxLOONGARCH64Gcc/c++Debug
 create mode 100644 wmake/rules/linuxLOONGARCH64Gcc/c++Opt
 create mode 100644 wmake/rules/linuxLOONGARCH64Gcc/c++Prof
 create mode 100644 wmake/rules/linuxLOONGARCH64Gcc/cDebug
 create mode 100644 wmake/rules/linuxLOONGARCH64Gcc/cOpt
 create mode 100644 wmake/rules/linuxLOONGARCH64Gcc/cProf
 create mode 100644 wmake/rules/linuxLOONGARCH64Gcc/general

diff --git a/etc/config.sh/settings b/etc/config.sh/settings
index 0a69a70190..88cbe0b6e9 100644
--- a/etc/config.sh/settings
+++ b/etc/config.sh/settings
@@ -117,6 +117,15 @@ Linux)
         export WM_CXXFLAGS='-m64 -fPIC -std=c++0x'
         export WM_LDFLAGS='-m64'
         ;;
+    loongarch64)
+        WM_ARCH=linuxLOONGARCH64
+        export WM_COMPILER_LIB_ARCH=64
+        export WM_CC='gcc'
+        export WM_CXX='g++'
+        export WM_CFLAGS=' -fPIC'
+        export WM_CXXFLAGS='-fPIC -std=c++0x'
+        export WM_LDFLAGS=' '
+        ;;
 
     *)
         echo Unknown processor type `uname -m` for Linux 1>&2
diff --git a/wmake/rules/linuxClang/c b/wmake/rules/linuxClang/c
index 2c8e8a7f9c..462d0cec76 100644
--- a/wmake/rules/linuxClang/c
+++ b/wmake/rules/linuxClang/c
@@ -2,7 +2,7 @@ SUFFIXES += .c
 
 cWARN        = -Wall
 
-cc          = clang -m32
+cc          = clang 
 
 include $(DEFAULT_RULES)/c$(WM_COMPILE_OPTION)
 
diff --git a/wmake/rules/linuxClang/c++ b/wmake/rules/linuxClang/c++
index f76912152b..61f57f14ae 100644
--- a/wmake/rules/linuxClang/c++
+++ b/wmake/rules/linuxClang/c++
@@ -8,7 +8,7 @@ c++WARN     = -Wall -Wextra -Wold-style-cast -Wnon-virtual-dtor \
 c++LESSWARN = -Wno-old-style-cast -Wno-unused-local-typedefs \
               -Wno-tautological-undefined-compare -Wno-shift-negative-value
 
-CC          = clang++ -std=c++14 -m32
+CC          = clang++ -std=c++14 
 
 include $(DEFAULT_RULES)/c++$(WM_COMPILE_OPTION)
 
diff --git a/wmake/rules/linuxGcc/c b/wmake/rules/linuxGcc/c
index 36e2163ccd..4e43bab733 100644
--- a/wmake/rules/linuxGcc/c
+++ b/wmake/rules/linuxGcc/c
@@ -2,7 +2,7 @@ SUFFIXES += .c
 
 cWARN        = -Wall
 
-cc          = gcc -m32
+cc          = gcc 
 
 include $(DEFAULT_RULES)/c$(WM_COMPILE_OPTION)
 
diff --git a/wmake/rules/linuxGcc/c++ b/wmake/rules/linuxGcc/c++
index 136e02a4b6..f0cf9f114f 100644
--- a/wmake/rules/linuxGcc/c++
+++ b/wmake/rules/linuxGcc/c++
@@ -6,7 +6,7 @@ c++WARN     = -Wall -Wextra -Wold-style-cast -Wnon-virtual-dtor \
 # Suppress some warnings for flex++
 c++LESSWARN = -Wno-old-style-cast -Wno-unused-local-typedefs -Wno-array-bounds
 
-CC          = g++ -std=c++14 -m32
+CC          = g++ -std=c++14 
 
 include $(DEFAULT_RULES)/c++$(WM_COMPILE_OPTION)
 
diff --git a/wmake/rules/linuxLOONGARCH64Gcc/X b/wmake/rules/linuxLOONGARCH64Gcc/X
new file mode 100644
index 0000000000..5d1f9c5cc5
--- /dev/null
+++ b/wmake/rules/linuxLOONGARCH64Gcc/X
@@ -0,0 +1,3 @@
+XFLAGS     =
+XINC       = $(XFLAGS) -I/usr/X11R6/include
+XLIBS      = -L/usr/X11R6/lib64 -lXext -lX11
diff --git a/wmake/rules/linuxLOONGARCH64Gcc/c b/wmake/rules/linuxLOONGARCH64Gcc/c
new file mode 100644
index 0000000000..4e43bab733
--- /dev/null
+++ b/wmake/rules/linuxLOONGARCH64Gcc/c
@@ -0,0 +1,18 @@
+SUFFIXES += .c
+
+cWARN        = -Wall
+
+cc          = gcc 
+
+include $(DEFAULT_RULES)/c$(WM_COMPILE_OPTION)
+
+cFLAGS      = $(GFLAGS) $(cWARN) $(cOPT) $(cDBUG) $(LIB_HEADER_DIRS) -fPIC
+
+ctoo        = $(WM_SCHEDULER) $(cc) $(cFLAGS) -c $< -o $@
+
+LINK_LIBS   = $(cDBUG)
+
+LINKLIBSO   = $(cc) -fuse-ld=bfd -shared
+
+LINKEXE     = $(cc) -fuse-ld=bfd \
+              -Xlinker --add-needed -Xlinker -z -Xlinker nodefs
diff --git a/wmake/rules/linuxLOONGARCH64Gcc/c++ b/wmake/rules/linuxLOONGARCH64Gcc/c++
new file mode 100644
index 0000000000..1fb5cbd28c
--- /dev/null
+++ b/wmake/rules/linuxLOONGARCH64Gcc/c++
@@ -0,0 +1,26 @@
+SUFFIXES += .C
+
+c++WARN     = -Wall -Wextra -Wold-style-cast -Wnon-virtual-dtor \
+              -Wno-unused-parameter -Wno-invalid-offsetof -Wno-attributes
+
+# Suppress some warnings for flex++
+c++LESSWARN = -Wno-old-style-cast -Wno-unused-local-typedefs -Wno-array-bounds
+
+CC          = g++ -std=c++14 
+
+include $(DEFAULT_RULES)/c++$(WM_COMPILE_OPTION)
+
+ptFLAGS     = -DNoRepository -ftemplate-depth-100
+
+c++FLAGS    = $(GFLAGS) $(c++WARN) $(c++OPT) $(c++DBUG) $(ptFLAGS) \
+              $(LIB_HEADER_DIRS) -fPIC
+
+Ctoo        = $(WM_SCHEDULER) $(CC) $(c++FLAGS) -c $< -o $@
+cxxtoo      = $(Ctoo)
+cctoo       = $(Ctoo)
+cpptoo      = $(Ctoo)
+
+LINK_LIBS   = $(c++DBUG)
+
+LINKLIBSO   = $(CC) $(c++FLAGS) -fuse-ld=bfd -shared
+LINKEXE     = $(CC) $(c++FLAGS) -fuse-ld=bfd -Xlinker --add-needed
diff --git a/wmake/rules/linuxLOONGARCH64Gcc/c++Debug b/wmake/rules/linuxLOONGARCH64Gcc/c++Debug
new file mode 100644
index 0000000000..19bdb9c334
--- /dev/null
+++ b/wmake/rules/linuxLOONGARCH64Gcc/c++Debug
@@ -0,0 +1,2 @@
+c++DBUG    = -ggdb3 -DFULLDEBUG
+c++OPT      = -O0 -fdefault-inline
diff --git a/wmake/rules/linuxLOONGARCH64Gcc/c++Opt b/wmake/rules/linuxLOONGARCH64Gcc/c++Opt
new file mode 100644
index 0000000000..599e6aba61
--- /dev/null
+++ b/wmake/rules/linuxLOONGARCH64Gcc/c++Opt
@@ -0,0 +1,4 @@
+c++DBUG     =
+c++OPT      = -O3
+
+ROUNDING_MATH = -frounding-math
diff --git a/wmake/rules/linuxLOONGARCH64Gcc/c++Prof b/wmake/rules/linuxLOONGARCH64Gcc/c++Prof
new file mode 100644
index 0000000000..3bda4dad55
--- /dev/null
+++ b/wmake/rules/linuxLOONGARCH64Gcc/c++Prof
@@ -0,0 +1,2 @@
+c++DBUG    = -pg
+c++OPT     = -O2
diff --git a/wmake/rules/linuxLOONGARCH64Gcc/cDebug b/wmake/rules/linuxLOONGARCH64Gcc/cDebug
new file mode 100644
index 0000000000..72b638f458
--- /dev/null
+++ b/wmake/rules/linuxLOONGARCH64Gcc/cDebug
@@ -0,0 +1,2 @@
+cDBUG       = -ggdb -DFULLDEBUG
+cOPT        = -O1 -fdefault-inline -finline-functions
diff --git a/wmake/rules/linuxLOONGARCH64Gcc/cOpt b/wmake/rules/linuxLOONGARCH64Gcc/cOpt
new file mode 100644
index 0000000000..17318709f1
--- /dev/null
+++ b/wmake/rules/linuxLOONGARCH64Gcc/cOpt
@@ -0,0 +1,2 @@
+cDBUG       =
+cOPT        = -O3
diff --git a/wmake/rules/linuxLOONGARCH64Gcc/cProf b/wmake/rules/linuxLOONGARCH64Gcc/cProf
new file mode 100644
index 0000000000..ca3ac9bf5f
--- /dev/null
+++ b/wmake/rules/linuxLOONGARCH64Gcc/cProf
@@ -0,0 +1,2 @@
+cDBUG       = -pg
+cOPT        = -O2
diff --git a/wmake/rules/linuxLOONGARCH64Gcc/general b/wmake/rules/linuxLOONGARCH64Gcc/general
new file mode 100644
index 0000000000..d84351d991
--- /dev/null
+++ b/wmake/rules/linuxLOONGARCH64Gcc/general
@@ -0,0 +1,9 @@
+LD         = ld -m elf64loongarch
+
+PROJECT_LIBS = -l$(WM_PROJECT) -ldl
+
+include $(GENERAL_RULES)/standard
+
+include $(DEFAULT_RULES)/X
+include $(DEFAULT_RULES)/c
+include $(DEFAULT_RULES)/c++
-- 
2.20.1

